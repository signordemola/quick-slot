generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  BUSINESS_OWNER
  STAFF
  CUSTOMER
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
  NO_SHOW
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

enum EmailStatus {
  PENDING
  SENT
  FAILED
  BOUNCED
}

model User {
  id                    String       @id @default(cuid())
  firstName             String       @map("first_name")
  lastName              String       @map("last_name")
  email                 String       @unique
  passwordHash          String       @map("password_hash")
  phoneNumber           String?      @map("phone_number")
  role                  UserRole     @default(CUSTOMER)
  isEmailVerified       Boolean      @default(false) @map("is_email_verified")
  emailVerificationToken String?     @unique @map("email_verification_token")
  passwordResetToken    String?      @unique @map("password_reset_token")
  passwordResetExpiry   DateTime?    @map("password_reset_expiry")
  createdAt             DateTime     @default(now()) @map("created_at")
  updatedAt             DateTime     @updatedAt @map("updated_at")

  ownedBusiness         Business?    @relation("BusinessOwner")
  staffProfile          Staff?
  bookings              Booking[]
  refreshTokens         RefreshToken[]

  @@index([email])
  @@map("users")
}

model RefreshToken {
  id                String       @id @default(cuid())
  userId            String       @map("user_id")
  token             String       @unique
  expiresAt         DateTime     @map("expires_at")
  createdAt         DateTime     @default(now()) @map("created_at")

  user              User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
}

model Business {
  id                String       @id @default(cuid())
  name              String
  description       String?
  email             String?
  phoneNumber       String?      @map("phone_number")
  address           String?
  city              String?
  country           String       @default("Nigeria")
  timezone          String       @default("Africa/Lagos")
  currency          String       @default("NGN")
  businessHours     Json?        @map("business_hours")
  createdAt         DateTime     @default(now()) @map("created_at")
  updatedAt         DateTime     @updatedAt @map("updated_at")

  ownerId           String       @unique @map("owner_id")
  owner             User         @relation("BusinessOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  staff             Staff[]
  services          Service[]
  bookings          Booking[]

  @@index([ownerId])
  @@map("businesses")
}

model Staff {
  id                String       @id @default(cuid())
  userId            String       @unique @map("user_id")
  businessId        String       @map("business_id")
  position          String?
  bio               String?
  isActive          Boolean      @default(true) @map("is_active")
  customSchedule    Json?        @map("custom_schedule")
  createdAt         DateTime     @default(now()) @map("created_at")
  updatedAt         DateTime     @updatedAt @map("updated_at")

  user              User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  business          Business     @relation(fields: [businessId], references: [id], onDelete: Cascade)
  services          Service[]
  bookings          Booking[]

  @@index([businessId])
  @@index([userId])
  @@map("staff")
}

model Service {
  id                String       @id @default(cuid())
  name              String
  description       String?
  durationMins      Int          @map("duration_mins")
  price             Decimal      @db.Decimal(10, 2)
  currency          String       @default("NGN")
  isActive          Boolean      @default(true) @map("is_active")
  createdAt         DateTime     @default(now()) @map("created_at")
  updatedAt         DateTime     @updatedAt @map("updated_at")

  businessId        String       @map("business_id")
  business          Business     @relation(fields: [businessId], references: [id], onDelete: Cascade)
  staffId           String       @map("staff_id")
  staff             Staff        @relation(fields: [staffId], references: [id], onDelete: Cascade)
  bookings          Booking[]

  @@index([businessId])
  @@index([staffId])
  @@index([isActive])
  @@map("services")
}

model Booking {
  id                String         @id @default(cuid())
  customerId        String         @map("customer_id")
  serviceId         String         @map("service_id")
  staffId           String         @map("staff_id")
  businessId        String         @map("business_id")
  startTime         DateTime       @map("start_time")
  endTime           DateTime       @map("end_time")
  status            BookingStatus  @default(PENDING)
  paymentStatus     PaymentStatus  @default(PENDING) @map("payment_status")
  customerNotes     String?        @map("customer_notes")
  staffNotes        String?        @map("staff_notes")
  cancellationReason String?       @map("cancellation_reason")
  createdAt         DateTime       @default(now()) @map("created_at")
  updatedAt         DateTime       @updatedAt @map("updated_at")
  confirmedAt       DateTime?      @map("confirmed_at")
  completedAt       DateTime?      @map("completed_at")
  cancelledAt       DateTime?      @map("cancelled_at")

  customer          User           @relation(fields: [customerId], references: [id])
  service           Service        @relation(fields: [serviceId], references: [id])
  staff             Staff          @relation(fields: [staffId], references: [id])
  business          Business       @relation(fields: [businessId], references: [id], onDelete: Cascade)
  payment           Payment?

  @@index([businessId])
  @@index([customerId])
  @@index([staffId])
  @@index([startTime, endTime])
  @@index([status])
  @@map("bookings")
}

model Payment {
  id                String         @id @default(cuid())
  bookingId         String         @unique @map("booking_id")
  amount            Decimal        @db.Decimal(10, 2)
  currency          String         @default("NGN")
  status            PaymentStatus  @default(PENDING)
  provider          String?
  providerRef       String?        @unique @map("provider_ref")
  webhookPayload    Json?          @map("webhook_payload")
  createdAt         DateTime       @default(now()) @map("created_at")
  updatedAt         DateTime       @updatedAt @map("updated_at")
  paidAt            DateTime?      @map("paid_at")

  booking           Booking        @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@index([providerRef])
  @@index([status])
  @@map("payments")
}

model EmailLog {
  id                String       @id @default(cuid())
  to                String
  subject           String
  template          String
  templateData      Json         @map("template_data")
  status            EmailStatus  @default(PENDING)
  error             String?
  provider          String?
  providerMessageId String?      @map("provider_message_id")
  createdAt         DateTime     @default(now()) @map("created_at")
  sentAt            DateTime?    @map("sent_at")

  @@index([to])
  @@index([status])
  @@index([createdAt])
  @@map("email_logs")
}